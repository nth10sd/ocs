# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: pytest-weekday

on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '5 4,10,16,22 * * 1-5'
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

### Copy to pytest-weekend.yml after this line ###
jobs:
  dbg-optDisabled-64-dm-linux:
    runs-on: ubuntu-20.04  # Or ${{ matrix.operating-system }}  # Fixate to exact OS versions to avoid potential test failures over time
    strategy:
      matrix:
        # operating-system: [ubuntu-20.04, macos-10.15, windows-2019]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: pip cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py') }}
        restore-keys: ${{ runner.os }}-pip-
    - name: Install pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      run: python -m pip install --upgrade pip setuptools wheel && python -m pip install -r requirements.txt '.[test]'
    - name: Run with flake8 and pylint, and also non-slow tests, using pytest
      run: pytest --flake8 --pylint -m "flake8 or pylint or not slow"

    - name: Set environment variables
      run: echo ::set-env name=LLVM_SYMBOLIZER::/usr/lib/llvm-9/bin/llvm-symbolizer && echo ::set-env name=LLVM_CONFIG::/usr/lib/llvm-9/bin/llvm-config && echo ::set-env name=SHELL::/bin/bash
    - name: Set llvm-config and llvm-symbolizer symlinks
      run: sudo ln -s /usr/lib/llvm-9/bin/llvm-config /usr/bin/llvm-config && sudo ln -s /usr/lib/llvm-9/bin/llvm-symbolizer /usr/bin/llvm-symbolizer
    - name: Check versions
      run: gcc --version; g++ --version; clang --version; clang++ --version; llvm-symbolizer --version; llvm-config --version
    - name: Install 32/64-bit SpiderMonkey prerequisites
      run: sudo apt-get install autoconf2.13 ccache g++-multilib lib32z1-dev libc6-dev-i386 libclang1-9
    - name: Rustup latest 32/64-bit Rust, as it seems faster than Rust-related workflows
      run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path && source "$HOME"/.cargo/env && rustup target add i686-unknown-linux-gnu
    - name: Clone Mercurial mozilla-central repo as a stream
      run: mkdir -p "$HOME"/trees && hg --version -q ; time hg clone --stream https://hg.mozilla.org/mozilla-central/ "$HOME"/trees/mozilla-central/

    - name: Compile a "--enable-debug --disable-optimize --enable-more-deterministic" build
      run: time python -m funfuzz.js.compile_shell -b "--enable-debug --disable-optimize --enable-more-deterministic"
    - name: Print the .busted log, if any, when any previous compile steps fail
      if: ${{ failure() }}
      run: tail -n 100 "$HOME"/shell-cache/*/*.busted*

    - name: Create a tarball and SHA-256 checksum, set "echo ::set-env name=ZSTD_CLEVEL::10" and put "--zstd" in tar parameters if we can upload artifacts as-s without being zipped
      run: pushd "$HOME"/shell-cache; for f in *; do [[ $f =~ "js-" ]] && time tar -cpf "$f".tar.zst "$f" && sha256sum "$f".tar.zst | tee "$f".tar.zst.sha256; done; popd
    - name: Archive tarball and checksum  # Zips files up until https://github.com/actions/upload-artifact/issues/14 gets fixed
      uses: actions/upload-artifact@v2
      with:
        path: '~/shell-cache/*.tar.zst*'

  dbg-optDisabled-32-dm-linux:
    runs-on: ubuntu-20.04  # Or ${{ matrix.operating-system }}  # Fixate to exact OS versions to avoid potential test failures over time
    strategy:
      matrix:
        # operating-system: [ubuntu-20.04, macos-10.15, windows-2019]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: pip cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py') }}
        restore-keys: ${{ runner.os }}-pip-
    - name: Install pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      run: python -m pip install --upgrade pip setuptools wheel && python -m pip install -r requirements.txt '.[test]'
    - name: Run with flake8 and pylint, and also non-slow tests, using pytest
      run: pytest --flake8 --pylint -m "flake8 or pylint or not slow"

    - name: Set environment variables
      run: echo ::set-env name=LLVM_SYMBOLIZER::/usr/lib/llvm-9/bin/llvm-symbolizer && echo ::set-env name=LLVM_CONFIG::/usr/lib/llvm-9/bin/llvm-config && echo ::set-env name=SHELL::/bin/bash
    - name: Set llvm-config and llvm-symbolizer symlinks
      run: sudo ln -s /usr/lib/llvm-9/bin/llvm-config /usr/bin/llvm-config && sudo ln -s /usr/lib/llvm-9/bin/llvm-symbolizer /usr/bin/llvm-symbolizer
    - name: Check versions
      run: gcc --version; g++ --version; clang --version; clang++ --version; llvm-symbolizer --version; llvm-config --version
    - name: Install 32/64-bit SpiderMonkey prerequisites
      run: sudo apt-get install autoconf2.13 ccache g++-multilib lib32z1-dev libc6-dev-i386 libclang1-9
    - name: Rustup latest 32/64-bit Rust, as it seems faster than Rust-related workflows
      run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path && source "$HOME"/.cargo/env && rustup target add i686-unknown-linux-gnu
    - name: Clone Mercurial mozilla-central repo as a stream
      run: mkdir -p "$HOME"/trees && hg --version -q ; time hg clone --stream https://hg.mozilla.org/mozilla-central/ "$HOME"/trees/mozilla-central/

    - name: Compile a "--enable-debug --disable-optimize --enable-more-deterministic --32" build
      run: time python -m funfuzz.js.compile_shell -b "--enable-debug --disable-optimize --enable-more-deterministic --32"
    - name: Print the .busted log, if any, when any previous compile steps fail
      if: ${{ failure() }}
      run: tail -n 100 "$HOME"/shell-cache/*/*.busted*

    - name: Create a tarball and SHA-256 checksum, set "echo ::set-env name=ZSTD_CLEVEL::10" and put "--zstd" in tar parameters if we can upload artifacts as-s without being zipped
      run: pushd "$HOME"/shell-cache; for f in *; do [[ $f =~ "js-" ]] && time tar -cpf "$f".tar.zst "$f" && sha256sum "$f".tar.zst | tee "$f".tar.zst.sha256; done; popd
    - name: Archive tarball and checksum  # Zips files up until https://github.com/actions/upload-artifact/issues/14 gets fixed
      uses: actions/upload-artifact@v2
      with:
        path: '~/shell-cache/*.tar.zst*'

  opt-64-linux:
    runs-on: ubuntu-20.04  # Or ${{ matrix.operating-system }}  # Fixate to exact OS versions to avoid potential test failures over time
    strategy:
      matrix:
        # operating-system: [ubuntu-20.04, macos-10.15, windows-2019]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: pip cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py') }}
        restore-keys: ${{ runner.os }}-pip-
    - name: Install pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      run: python -m pip install --upgrade pip setuptools wheel && python -m pip install -r requirements.txt '.[test]'
    - name: Run with flake8 and pylint, and also non-slow tests, using pytest
      run: pytest --flake8 --pylint -m "flake8 or pylint or not slow"

    - name: Set environment variables
      run: echo ::set-env name=LLVM_SYMBOLIZER::/usr/lib/llvm-9/bin/llvm-symbolizer && echo ::set-env name=LLVM_CONFIG::/usr/lib/llvm-9/bin/llvm-config && echo ::set-env name=SHELL::/bin/bash
    - name: Set llvm-config and llvm-symbolizer symlinks
      run: sudo ln -s /usr/lib/llvm-9/bin/llvm-config /usr/bin/llvm-config && sudo ln -s /usr/lib/llvm-9/bin/llvm-symbolizer /usr/bin/llvm-symbolizer
    - name: Check versions
      run: gcc --version; g++ --version; clang --version; clang++ --version; llvm-symbolizer --version; llvm-config --version
    - name: Install 32/64-bit SpiderMonkey prerequisites
      run: sudo apt-get install autoconf2.13 ccache g++-multilib lib32z1-dev libc6-dev-i386 libclang1-9
    - name: Rustup latest 32/64-bit Rust, as it seems faster than Rust-related workflows
      run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path && source "$HOME"/.cargo/env && rustup target add i686-unknown-linux-gnu
    - name: Clone Mercurial mozilla-central repo as a stream
      run: mkdir -p "$HOME"/trees && hg --version -q ; time hg clone --stream https://hg.mozilla.org/mozilla-central/ "$HOME"/trees/mozilla-central/

    - name: Compile a "" build
      run: time python -m funfuzz.js.compile_shell
    - name: Print the .busted log, if any, when any previous compile steps fail
      if: ${{ failure() }}
      run: tail -n 100 "$HOME"/shell-cache/*/*.busted*

    - name: Create a tarball and SHA-256 checksum, set "echo ::set-env name=ZSTD_CLEVEL::10" and put "--zstd" in tar parameters if we can upload artifacts as-s without being zipped
      run: pushd "$HOME"/shell-cache; for f in *; do [[ $f =~ "js-" ]] && time tar -cpf "$f".tar.zst "$f" && sha256sum "$f".tar.zst | tee "$f".tar.zst.sha256; done; popd
    - name: Archive tarball and checksum  # Zips files up until https://github.com/actions/upload-artifact/issues/14 gets fixed
      uses: actions/upload-artifact@v2
      with:
        path: '~/shell-cache/*.tar.zst*'

  opt-64-asan-linux:
    runs-on: ubuntu-20.04  # Or ${{ matrix.operating-system }}  # Fixate to exact OS versions to avoid potential test failures over time
    strategy:
      matrix:
        # operating-system: [ubuntu-20.04, macos-10.15, windows-2019]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: pip cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py') }}
        restore-keys: ${{ runner.os }}-pip-
    - name: Install pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      run: python -m pip install --upgrade pip setuptools wheel && python -m pip install -r requirements.txt '.[test]'
    - name: Run with flake8 and pylint, and also non-slow tests, using pytest
      run: pytest --flake8 --pylint -m "flake8 or pylint or not slow"

    - name: Set environment variables
      run: echo ::set-env name=LLVM_SYMBOLIZER::/usr/lib/llvm-9/bin/llvm-symbolizer && echo ::set-env name=LLVM_CONFIG::/usr/lib/llvm-9/bin/llvm-config && echo ::set-env name=SHELL::/bin/bash
    - name: Set llvm-config and llvm-symbolizer symlinks
      run: sudo ln -s /usr/lib/llvm-9/bin/llvm-config /usr/bin/llvm-config && sudo ln -s /usr/lib/llvm-9/bin/llvm-symbolizer /usr/bin/llvm-symbolizer
    - name: Check versions
      run: gcc --version; g++ --version; clang --version; clang++ --version; llvm-symbolizer --version; llvm-config --version
    - name: Install 32/64-bit SpiderMonkey prerequisites
      run: sudo apt-get install autoconf2.13 ccache g++-multilib lib32z1-dev libc6-dev-i386 libclang1-9
    - name: Rustup latest 32/64-bit Rust, as it seems faster than Rust-related workflows
      run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path && source "$HOME"/.cargo/env && rustup target add i686-unknown-linux-gnu
    - name: Clone Mercurial mozilla-central repo as a stream
      run: mkdir -p "$HOME"/trees && hg --version -q ; time hg clone --stream https://hg.mozilla.org/mozilla-central/ "$HOME"/trees/mozilla-central/

    - name: Compile a "--enable-address-sanitizer" build
      run: time python -m funfuzz.js.compile_shell -b "--enable-address-sanitizer"
    - name: Print the .busted log, if any, when any previous compile steps fail
      if: ${{ failure() }}
      run: tail -n 100 "$HOME"/shell-cache/*/*.busted*

    - name: Create a tarball and SHA-256 checksum, set "echo ::set-env name=ZSTD_CLEVEL::10" and put "--zstd" in tar parameters if we can upload artifacts as-s without being zipped
      run: pushd "$HOME"/shell-cache; for f in *; do [[ $f =~ "js-" ]] && time tar -cpf "$f".tar.zst "$f" && sha256sum "$f".tar.zst | tee "$f".tar.zst.sha256; done; popd
    - name: Archive tarball and checksum  # Zips files up until https://github.com/actions/upload-artifact/issues/14 gets fixed
      uses: actions/upload-artifact@v2
      with:
        path: '~/shell-cache/*.tar.zst*'

  opt-32-linux:
    runs-on: ubuntu-20.04  # Or ${{ matrix.operating-system }}  # Fixate to exact OS versions to avoid potential test failures over time
    strategy:
      matrix:
        # operating-system: [ubuntu-20.04, macos-10.15, windows-2019]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: pip cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py') }}
        restore-keys: ${{ runner.os }}-pip-
    - name: Install pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      run: python -m pip install --upgrade pip setuptools wheel && python -m pip install -r requirements.txt '.[test]'
    - name: Run with flake8 and pylint, and also non-slow tests, using pytest
      run: pytest --flake8 --pylint -m "flake8 or pylint or not slow"

    - name: Set environment variables
      run: echo ::set-env name=LLVM_SYMBOLIZER::/usr/lib/llvm-9/bin/llvm-symbolizer && echo ::set-env name=LLVM_CONFIG::/usr/lib/llvm-9/bin/llvm-config && echo ::set-env name=SHELL::/bin/bash
    - name: Set llvm-config and llvm-symbolizer symlinks
      run: sudo ln -s /usr/lib/llvm-9/bin/llvm-config /usr/bin/llvm-config && sudo ln -s /usr/lib/llvm-9/bin/llvm-symbolizer /usr/bin/llvm-symbolizer
    - name: Check versions
      run: gcc --version; g++ --version; clang --version; clang++ --version; llvm-symbolizer --version; llvm-config --version
    - name: Install 32/64-bit SpiderMonkey prerequisites
      run: sudo apt-get install autoconf2.13 ccache g++-multilib lib32z1-dev libc6-dev-i386 libclang1-9
    - name: Rustup latest 32/64-bit Rust, as it seems faster than Rust-related workflows
      run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path && source "$HOME"/.cargo/env && rustup target add i686-unknown-linux-gnu
    - name: Clone Mercurial mozilla-central repo as a stream
      run: mkdir -p "$HOME"/trees && hg --version -q ; time hg clone --stream https://hg.mozilla.org/mozilla-central/ "$HOME"/trees/mozilla-central/

    - name: Compile a "--32" build
      run: time python -m funfuzz.js.compile_shell -b "--32"
    - name: Print the .busted log, if any, when any previous compile steps fail
      if: ${{ failure() }}
      run: tail -n 100 "$HOME"/shell-cache/*/*.busted*

    - name: Create a tarball and SHA-256 checksum, set "echo ::set-env name=ZSTD_CLEVEL::10" and put "--zstd" in tar parameters if we can upload artifacts as-s without being zipped
      run: pushd "$HOME"/shell-cache; for f in *; do [[ $f =~ "js-" ]] && time tar -cpf "$f".tar.zst "$f" && sha256sum "$f".tar.zst | tee "$f".tar.zst.sha256; done; popd
    - name: Archive tarball and checksum  # Zips files up until https://github.com/actions/upload-artifact/issues/14 gets fixed
      uses: actions/upload-artifact@v2
      with:
        path: '~/shell-cache/*.tar.zst*'

  dbg-optDisabled-32-dm-armsim32-linux:
    runs-on: ubuntu-20.04  # Or ${{ matrix.operating-system }}  # Fixate to exact OS versions to avoid potential test failures over time
    strategy:
      matrix:
        # operating-system: [ubuntu-20.04, macos-10.15, windows-2019]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: pip cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py') }}
        restore-keys: ${{ runner.os }}-pip-
    - name: Install pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      run: python -m pip install --upgrade pip setuptools wheel && python -m pip install -r requirements.txt '.[test]'
    - name: Run with flake8 and pylint, and also non-slow tests, using pytest
      run: pytest --flake8 --pylint -m "flake8 or pylint or not slow"

    - name: Set environment variables
      run: echo ::set-env name=LLVM_SYMBOLIZER::/usr/lib/llvm-9/bin/llvm-symbolizer && echo ::set-env name=LLVM_CONFIG::/usr/lib/llvm-9/bin/llvm-config && echo ::set-env name=SHELL::/bin/bash
    - name: Set llvm-config and llvm-symbolizer symlinks
      run: sudo ln -s /usr/lib/llvm-9/bin/llvm-config /usr/bin/llvm-config && sudo ln -s /usr/lib/llvm-9/bin/llvm-symbolizer /usr/bin/llvm-symbolizer
    - name: Check versions
      run: gcc --version; g++ --version; clang --version; clang++ --version; llvm-symbolizer --version; llvm-config --version
    - name: Install 32/64-bit SpiderMonkey prerequisites
      run: sudo apt-get install autoconf2.13 ccache g++-multilib lib32z1-dev libc6-dev-i386 libclang1-9
    - name: Rustup latest 32/64-bit Rust, as it seems faster than Rust-related workflows
      run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path && source "$HOME"/.cargo/env && rustup target add i686-unknown-linux-gnu
    - name: Clone Mercurial mozilla-central repo as a stream
      run: mkdir -p "$HOME"/trees && hg --version -q ; time hg clone --stream https://hg.mozilla.org/mozilla-central/ "$HOME"/trees/mozilla-central/

    - name: Compile a "--enable-debug --disable-optimize --enable-more-deterministic --enable-simulator=arm --32" build
      run: time python -m funfuzz.js.compile_shell -b "--enable-debug --disable-optimize --enable-more-deterministic --enable-simulator=arm --32"
    - name: Print the .busted log, if any, when any previous compile steps fail
      if: ${{ failure() }}
      run: tail -n 100 "$HOME"/shell-cache/*/*.busted*

    - name: Create a tarball and SHA-256 checksum, set "echo ::set-env name=ZSTD_CLEVEL::10" and put "--zstd" in tar parameters if we can upload artifacts as-s without being zipped
      run: pushd "$HOME"/shell-cache; for f in *; do [[ $f =~ "js-" ]] && time tar -cpf "$f".tar.zst "$f" && sha256sum "$f".tar.zst | tee "$f".tar.zst.sha256; done; popd
    - name: Archive tarball and checksum  # Zips files up until https://github.com/actions/upload-artifact/issues/14 gets fixed
      uses: actions/upload-artifact@v2
      with:
        path: '~/shell-cache/*.tar.zst*'

  dbg-optDisabled-64-dm-armsim64-linux:
    runs-on: ubuntu-20.04  # Or ${{ matrix.operating-system }}  # Fixate to exact OS versions to avoid potential test failures over time
    strategy:
      matrix:
        # operating-system: [ubuntu-20.04, macos-10.15, windows-2019]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: echo "::set-output name=dir::$(pip cache dir)"
    - name: pip cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-${{ hashFiles('**/setup.py') }}
        restore-keys: ${{ runner.os }}-pip-
    - name: Install pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      run: python -m pip install --upgrade pip setuptools wheel && python -m pip install -r requirements.txt '.[test]'
    - name: Run with flake8 and pylint, and also non-slow tests, using pytest
      run: pytest --flake8 --pylint -m "flake8 or pylint or not slow"

    - name: Set environment variables
      run: echo ::set-env name=LLVM_SYMBOLIZER::/usr/lib/llvm-9/bin/llvm-symbolizer && echo ::set-env name=LLVM_CONFIG::/usr/lib/llvm-9/bin/llvm-config && echo ::set-env name=SHELL::/bin/bash
    - name: Set llvm-config and llvm-symbolizer symlinks
      run: sudo ln -s /usr/lib/llvm-9/bin/llvm-config /usr/bin/llvm-config && sudo ln -s /usr/lib/llvm-9/bin/llvm-symbolizer /usr/bin/llvm-symbolizer
    - name: Check versions
      run: gcc --version; g++ --version; clang --version; clang++ --version; llvm-symbolizer --version; llvm-config --version
    - name: Install 32/64-bit SpiderMonkey prerequisites
      run: sudo apt-get install autoconf2.13 ccache g++-multilib lib32z1-dev libc6-dev-i386 libclang1-9
    - name: Rustup latest 32/64-bit Rust, as it seems faster than Rust-related workflows
      run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path && source "$HOME"/.cargo/env && rustup target add i686-unknown-linux-gnu
    - name: Clone Mercurial mozilla-central repo as a stream
      run: mkdir -p "$HOME"/trees && hg --version -q ; time hg clone --stream https://hg.mozilla.org/mozilla-central/ "$HOME"/trees/mozilla-central/

    - name: Compile a "--enable-debug --disable-optimize --enable-more-deterministic --enable-simulator=arm64" build
      run: time python -m funfuzz.js.compile_shell -b "--enable-debug --disable-optimize --enable-more-deterministic --enable-simulator=arm64"
    - name: Print the .busted log, if any, when any previous compile steps fail
      if: ${{ failure() }}
      run: tail -n 100 "$HOME"/shell-cache/*/*.busted*

    - name: Create a tarball and SHA-256 checksum, set "echo ::set-env name=ZSTD_CLEVEL::10" and put "--zstd" in tar parameters if we can upload artifacts as-s without being zipped
      run: pushd "$HOME"/shell-cache; for f in *; do [[ $f =~ "js-" ]] && time tar -cpf "$f".tar.zst "$f" && sha256sum "$f".tar.zst | tee "$f".tar.zst.sha256; done; popd
    - name: Archive tarball and checksum  # Zips files up until https://github.com/actions/upload-artifact/issues/14 gets fixed
      uses: actions/upload-artifact@v2
      with:
        path: '~/shell-cache/*.tar.zst*'
